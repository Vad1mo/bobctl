apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "mywebapp.fullname" . }}-test-connection"
  labels:
    {{- include "mywebapp.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": hook-succeeded     #,hook-failed
spec:
  restartPolicy: Never
  containers:
    - name: curl
      image: curlimages/curl:8.7.1
      command:
        - /bin/sh
        - -c
        - |
          set -ex
          SERVICE="{{ include "mywebapp.fullname" . }}"
          NAMESPACE="{{ .Release.Namespace }}"
          PORT="{{ .Values.service.port }}"
          URL="${SERVICE}.${NAMESPACE}.svc.cluster.local:${PORT}/ping.php?ip=172.16.0.2"
          RESPONSE=$(curl -s "$URL")
          echo "$RESPONSE"
          echo "$RESPONSE" | grep -q "Ping results for 172.16.0.2"
          echo "$RESPONSE" | grep -q "64 bytes from 172.16.0.2: icmp_seq=1"
          echo "$RESPONSE" | grep -q "4 packets transmitted, 4 received, 0% packet loss"